<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width"><title>Detecting when a page is loaded from the browser cache - Karl O'Keeffe</title><link rel="alternate" href="/feed.xml" type="application/rss+xml" title=""><link rel="apple-touch-icon" href="/apple-touch-icon.png"><style>body {
  box-sizing: border-box;
  color: #333;
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 11px; /* For the PDF CV */
  letter-spacing: 0.2px;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  word-wrap: break-word;
}

.page {
  font-size: 16px; /* For the Website */
}

a {
  color: #2469C8;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

h1, h2, h3, h4, h5, h6, p, body, a, img, ul, ol, blockquote, pre {
  margin: 0; padding: 0; border: 0;
}

body {
  background-color: #ffffff;
  /*text-rendering: optimizeLegibility;*/
}

.content-wrap {
  width: 34em;
  margin: 0 auto;
}

p {
  margin-top: 0;
  margin-bottom: 16px;
}

h1 {
  font-size: 2em;
  margin-bottom: 1em;
}

h2 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  padding-bottom: .3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

h3 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  font-size: 1.5em;
  line-height: 1.43;
}

ol, ul {
  padding: 0;
  padding-left: 2em;
  margin-top: 0;
  margin-bottom: 16px;
}

blockquote {
  margin: 1.2em 3em;
  padding-left: 1em;
  font-style: italic;
}

hr {
  border: 0;
  border-top: 1px dashed #d2d2d2;
  height: 0;
  margin: 1.6em 0;
}

/* page header */

.header {
  padding: 2em;
  background: #FFA91A;
}

.header h1 {
  font-size: 2.6em;
  text-align: center;
  font-weight: 700;
  margin: 0;
}

.header a, .header a:hover {
  text-decoration: none;
  color: #ffffff;
}

/* page footer */

footer {
  margin: 3em 0;
}

footer .nav {
  text-align: center;
  margin-top: 5em;
  margin-bottom: 3.5em;
}

footer .nav a {
  padding: 0 0.5em;
  font-size: 1.2em;
  text-decoration: none;
}

footer .about {
  padding: 2.2em 3em;
  text-align: center;
  color: #888;
}

/* article */

.article {
  margin: 3em 0 4em;
}

.article header .date {
  text-align: center;
  margin-top: -0.7em;
}

.article .content img {
  display: block;
  width: 100%;
}

/* code styling */

p code,
h2 code {
  font-family: Consolas,"Liberation Mono",Menlo,Courier,monospace;
  padding: 0;
  padding-top: .2em;
  padding-bottom: .2em;
  margin: 0;
  font-size: 85%;
  background-color: #f7f7f7;
  border-radius: 3px;
}

h2 code:before,
h2 code:after,
p code:before,
p code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

pre {
  font-family: Consolas,"Liberation Mono",Menlo,Courier,monospace;
  word-wrap: normal;
  padding: 16px;
  overflow: auto;
  /*font-size: 100%;*/
  font-size: 13.6px;
  line-height: 1.45;
  background-color: #f7f7f7;
  border: 0;
  border-radius: 3px;
  margin-top: 0;
  margin-bottom: 16px;
}

pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
  /*font-size: 100%;*/
  white-space: pre;
  background: transparent;
  border-radius: 3px;
}

/* syntax hl stuff */

code.lang-markdown {
  color: #424242;
}

code.lang-markdown .header,
code.lang-markdown .strong {
  font-weight: bold;
}

code.lang-markdown .emphasis {
  font-style: italic;
}

code.lang-markdown .horizontal_rule,
code.lang-markdown .link_label,
code.lang-markdown .code,
code.lang-markdown .header,
code.lang-markdown .link_url {
  color: #555;
}

code.lang-markdown .blockquote,
code.lang-markdown .bullet {
  color: #bbb;
}

/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
.tomorrow-comment, pre .comment, pre .title {
  color: #8e908c;
}

.tomorrow-red, pre .variable, pre .attribute, pre .tag, pre .regexp, pre .ruby .constant, pre .xml .tag .title, pre .xml .pi, pre .xml .doctype, pre .html .doctype, pre .css .id, pre .css .class, pre .css .pseudo {
  color: #c82829;
}

.tomorrow-orange, pre .number, pre .preprocessor, pre .built_in, pre .literal, pre .params, pre .constant {
  color: #f5871f;
}

.tomorrow-yellow, pre .class, pre .ruby .class .title, pre .css .rules .attribute {
  color: #eab700;
}

.tomorrow-green, pre .string, pre .value, pre .inheritance, pre .header, pre .ruby .symbol, pre .xml .cdata {
  color: #718c00;
}

.tomorrow-aqua, pre .css .hexcolor {
  color: #3e999f;
}

.tomorrow-blue, pre .function, pre .python .decorator, pre .python .title, pre .ruby .function .title, pre .ruby .title .keyword, pre .perl .sub, pre .javascript .title, pre .coffeescript .title {
  color: #4271ae;
}

.tomorrow-purple, pre .keyword, pre .javascript .function {
  color: #8959a8;
}

/* media queries */

@media (max-width: 690px) {
  .content-wrap {
    width: auto;
    padding: 0 1em;
  }
  .header {
    padding: 1em;
  }
  .header h1 {
    font-size: 1.4em;
  }
  .article {
    margin: 1em 0 2.5em;
  }
  .archive {
    width: 80%;
    margin: 0 auto;
  }
  .archive * {
    float: none !important;
    line-height: 1.6 !important;
    width: auto !important;
    height: auto !important;
    text-align: left !important;
    border: 0 !important;
    margin: 0 !important;
  }
  footer .nav {
    margin: 1em 0;
  }
  footer .about {
    padding: 0;
    padding-top: 1.6em;
  }
  footer .about p {
    margin-bottom: 1em;
  }
}
</style></head><body class="page"><header class="header"><div class="content-wrap"><div class="logo"><h1><a href="/">Karl O'Keeffe</a></h1></div></div></header><div id="content"><div class="content-wrap"><article class="article"><header><h2><a href="/blog/articles/detecting-when-a-page-is-loaded-from-the-browser-cache/">Detecting when a page is loaded from the browser cache</a></h2><p class="date"><span>12. February 2010</span></p></header><section class="content"><p>When a user presses the back button in their browser to return to a previous page, that page is usually loaded straight from the browserâ€™s cache, without any requests being made to the server. When that page shows information that could be out of date (such a an old list of products in your basket) this can cause<span class="widont">&nbsp;</span>problems.</p>
<p>So how about we knock up a little code that allows us to determine whether the page has been loaded from the server or the browsers cache. Then we can reload those parts of the page that may need updating (such as the<span class="widont">&nbsp;</span>basket).</p>
<p>We can do this by setting a cookie on every response from the server, and modifying that cookie using javascript. We can then use this cookie to know whether the page has been loaded from the server or the browser<span class="widont">&nbsp;</span>cache.</p>
<h2 id="setting-the-cookie-on-every-response-from-the-server">Setting the cookie on every response from the<span class="widont">&nbsp;</span>server</h2>
<p>We will use a <code>loadedFromBrowserCache</code> cookie to facilitate the cache detection. We will set it to <code>false</code> every time a page is loaded from the<span class="widont">&nbsp;</span>server.</p>
<p>You can use the <code>BrowserCacheIndicator</code> class below to manage the<span class="widont">&nbsp;</span>cookie.</p>
<h3 id="browsercacheindicator-cs">BrowserCacheIndicator.cs</h3>
<pre><code class="language-csharp"><span class="keyword">using</span> System.Web;

<span class="keyword">namespace</span> <span class="title">SevenDigital.Web.Com.Code</span> {
    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BrowserCacheIndicator</span> {
        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> CACHE_COOKIE = <span class="string">"loadedFromBrowserCache"</span>;

        <span class="comment">// This works with the javascript on the site to determine whether</span>
        <span class="comment">// a page has been loaded from the browser cache</span>

        <span class="comment">// *Every time* a page is loaded from the server we need to set</span>
        <span class="comment">// the loadedFromBrowserCache cookie to false</span>

        <span class="comment">// This method should be called in all Master Pages</span>
        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearCacheCookie</span>(<span class="params">HttpResponse response</span>)</span> {
            response.SetCookie(<span class="keyword">new</span> HttpCookie(CACHE_COOKIE, <span class="string">"false"</span>));
        }
    }
}</code></pre>
<p>And then set the cookie in every Master<span class="widont">&nbsp;</span>page:</p>
<pre><code class="language-csharp"><span class="keyword">namespace</span> <span class="title">SevenDigital.Web.Com</span> {
    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">ExampleMasterPage</span>: <span class="title">BaseMasterPage</span> {
        <span class="keyword">protected</span> <span class="keyword">readonly</span> BrowserCacheIndicator BrowserCacheIndicator = <span class="keyword">new</span> BrowserCacheIndicator();

        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Page_Load</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span> {
            BrowserCacheIndicator.ClearCacheCookie(Response);
        }
    }
}</code></pre>
<h2 id="using-the-cookie-to-know-whether-the-page-was-loaded-from-the-browser-cache">Using the cookie to know whether the page was loaded from the browser<span class="widont">&nbsp;</span>cache</h2>
<p>The <code>loadedFromBrowserCache</code> cookie will be reset set to <code>false</code> by the <span class="caps">HTTP</span> Response header every time the page is loaded from the server. But it will not be reset when the page is loaded from the cache. We can use this to our advantage by setting the <code>loadedFromBrowserCache</code> cookie to <code>true</code> in javascript.</p>
<p>Then we know that the browser was loaded from the cache if the cookie is true on page load (because it was not reset by the<span class="widont">&nbsp;</span>server).</p>
<p>We just need to make sure we check the cookie before we set it to <code>true</code>!</p>
<h3 id="browser-cache-js">browser-cache.js</h3>
<pre><code class="language-javascript"><span class="comment">// Detect whether or not we are loading this page from the browser cache</span>
<span class="comment">// Set the value $.loadedFromBrowserCache, which other scripts can use</span>
(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
    <span class="keyword">var</span> CACHE_COOKIE = <span class="string">'loadedFromBrowserCache'</span>;
    jQuery.loadedFromBrowserCache = getCookie(CACHE_COOKIE) == <span class="string">'true'</span>;
    setCookie(CACHE_COOKIE, <span class="string">'true'</span>);
})();</code></pre>
<p>Now we have a <code>$.loadedFromBrowserCache</code> variable that letâ€™s us know whether the page was loaded from the browser<span class="widont">&nbsp;</span>cache.</p>
<p>Note, the above function can run immediately, it does not need to wait for the <code>jQuery</code> <code>ready</code> event, or the <code>window.onload</code> event as it does not modify the<span class="widont">&nbsp;</span><span class="caps">DOM</span>.</p>
<h2 id="using-loadedfrombrowsercache-to-do-something-useful">Using <code>$.loadedFromBrowserCache</code> to do something<span class="widont">&nbsp;</span>useful</h2>
<p>Now we can do something useful with the knowledge a page was reloaded from the cache. How about reloading the users basket to ensure it is always up to<span class="widont">&nbsp;</span>date:</p>
<pre><code class="language-javascript"><span class="comment">// Reload the basket using ajax</span>
<span class="comment">// This is so that users still see the latest basket when using the back</span>
<span class="comment">// button in their browsers</span>
$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
    <span class="keyword">if</span> ($.loadedFromBrowserCache) {
        refreshBasket();
    }
});</code></pre>
<p>Enjoy!</p>
</section></article></div></div><footer><div class="content-wrap"><div class="nav"><a href="/blog/">Full blog</a></div><section class="about"><p>Personal homepage of <a href="/">Karl Oâ€™Keeffe</a>.</p>
</section></div></footer></body></html>
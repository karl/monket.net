<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Javascript Lint with Autotest - Karl O'Keeffe
    </title>
    <link rel="alternate" href="//feed.xml" type="application/rss+xml" title="">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <div class="logo">
          <h1><a href="/">Karl O'Keeffe</a></h1>
          <p class="description"></p>
        </div>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>As well as using <a href="/articles/autotest-cucumber-and-growl/">Autotest to run Cucumber scenarios</a> I have also been looking into integrating lower level test into the Autotest&nbsp;cycle.</p>
<p>My first attempt at this is a small module to run <a href="http://javascriptlint.com/">Javascript Lint</a> on all the javascript files within a project any time any file&nbsp;changes.</p>
<p>The module below hooks in to Autotest just before the tests are normally run. It runs javascript lint over all the <code>*.js</code> files in the project, outputs the results to the autotest results object and the standard output, and finally fires a new <code>ran_javascript_lint</code> hook</p>
<p>Errors and warnings found by Javascript Lint will also be notified through <a href="http://growl.info/">Growl</a> (if Growl and <a href="http://github.com/svoop/autotest-growl/tree/master">autotest-growl</a> are installed). If there are no errors or warnings than no Growl notification is shown. This keeps distracting popups to a&nbsp;minimum.</p>
<h2 id="installing-autotest-javascript-lint">Installing Autotest Javascript&nbsp;Lint</h2>
<p>First up, <a href="http://javascriptlint.com/download.htm">download Javascript Lint</a>. Extract the <code>jsl</code> executable to <code>lib/autotest/</code> within your&nbsp;project.</p>
<p>Copy the code below to <code>lib/autotest/javascript-lint.rb</code> within your project (the same directory where you have the <code>jsl</code> execuatable).</p>
<h4 id="javascript-lint-rb">javascript-lint.rb</h4>
<pre><code class="lang-ruby"><span class="comment"># Run Javascript Lint as part of autotest</span>
<span class="comment"># Supports Growl notifications if using autotest-growl</span>
<span class="comment">#</span>
<span class="comment"># Version 1.0</span>

<span class="keyword">require</span> <span class="string">'autotest'</span>

<span class="class"><span class="keyword">module</span> <span class="title">Autotest::JavascriptLint</span></span>
    <span class="variable">@@js_dir</span> = <span class="string">''</span>
    <span class="variable">@@jsl_dir</span> = <span class="constant">File</span>.dirname(__FILE_<span class="number">_</span>) + <span class="string">'/'</span>
    <span class="variable">@@config_file</span> = <span class="string">''</span>

    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">js_dir=</span><span class="params">(string)</span></span>
        <span class="variable">@@js_dir</span> = string
    <span class="keyword">end</span>

    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">jsl_dir=</span><span class="params">(string)</span></span>
        <span class="variable">@@jsl_dir</span> = string
    <span class="keyword">end</span>

    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">config_file=</span><span class="params">(string)</span></span>
        <span class="variable">@@config_file</span> = string
    <span class="keyword">end</span>

    <span class="constant">Autotest</span>.add_hook <span class="symbol">:run_command</span> <span class="keyword">do</span> |at|

        <span class="comment"># run javascript lint</span>
        results = <span class="string">`<span class="subst">#{<span class="variable">@@jsl_dir</span>}</span>jsl -conf "<span class="subst">#{<span class="variable">@@config_file</span>}</span>"  -process "<span class="subst">#{<span class="variable">@@js_dir</span>}</span>*.js" +recurse`</span>
        puts results

        at.results = [] <span class="keyword">if</span> at.results.<span class="keyword">nil</span>?
        at.results.concat(results.split(<span class="string">"\n"</span>))

        at.hook <span class="symbol">:ran_javascript_lint</span>
    <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="class"><span class="keyword">module</span> <span class="title">Autotest::Growl</span></span>

    <span class="variable">@@show_js_lint_success</span> = <span class="keyword">false</span>

    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">show_js_lint_success=</span><span class="params">(bool)</span></span>
        <span class="variable">@@show_js_lint_success</span>=bool
    <span class="keyword">end</span>

    <span class="comment"># Growl results of Javscript Lint</span>
    <span class="constant">Autotest</span>.add_hook <span class="symbol">:ran_javascript_lint</span> <span class="keyword">do</span> |autotest|
        gist = autotest.results.grep(<span class="regexp">/\d+\s+error.*,\s+\d+\s+warning.*/</span>).join(<span class="string">" / "</span>).strip()

        <span class="keyword">if</span> gist == <span class="string">''</span>
            growl <span class="variable">@label</span> + <span class="string">'Cannot run javascript lint.'</span>, <span class="string">''</span>, <span class="string">'error'</span>
        <span class="keyword">else</span>
            <span class="keyword">if</span> gist =~ <span class="regexp">/[1-9]\d*\s+(error)/</span>
                growl <span class="variable">@label</span> + <span class="string">'Lint: Some files have errors.'</span>, gist, <span class="string">'failed'</span>
            <span class="keyword">elsif</span> gist =~ <span class="regexp">/[1-9]\d*\s+(warning)/</span>
                growl <span class="variable">@label</span> + <span class="string">'Lint: Some files have warnings.'</span>, gist, <span class="string">'pending'</span>
            <span class="keyword">elsif</span> <span class="variable">@@show_js_lint_success</span>
                growl <span class="variable">@label</span> + <span class="string">'Lint: All files are clean.'</span>, gist, <span class="string">'passed'</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">false</span>
    <span class="keyword">end</span>

<span class="keyword">end</span>
</code></pre>
<p>Then add Autotest Javascript Lint to your <code>.autotest</code> configuration file within the base of your&nbsp;project.</p>
<pre><code class="lang-ruby"><span class="keyword">require</span> <span class="string">'lib/autotest/javascript-lint'</span>
</code></pre>
<h2 id="to-do">To&nbsp;Do</h2>
<p>This could be packaged as a gem for easy installation, and it could possibly be modified to only run over changed&nbsp;files.</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/blog/">« Full blog</a></div>
        <section class="about"><p>Personal homepage of Karl O’Keeffe.</p>

        </section>
      </div>
    </footer>
  </body>
</html>
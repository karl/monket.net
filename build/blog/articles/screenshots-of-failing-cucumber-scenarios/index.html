<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Screenshots of Failing Cucumber Scenarios - Karl O'Keeffe
    </title>
    <link rel="alternate" href="/feed.xml" type="application/rss+xml" title="">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <style>body {
  box-sizing: border-box;
  color: #333;
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 16px;
  letter-spacing: 0.2px;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  word-wrap: break-word;
}

a {
  color: #2469C8;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

h1, h2, h3, h4, h5, h6, p, body, a, img, ul, ol, blockquote, pre {
  margin: 0; padding: 0; border: 0;
}

body {
  background-color: #ffffff;
  /*text-rendering: optimizeLegibility;*/
}

.content-wrap {
  width: 34em;
  margin: 0 auto;
}

p {
  margin-top: 0;
  margin-bottom: 16px;
}

h1 {
  font-size: 2em;
  margin-bottom: 1em;
}

h2 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  padding-bottom: .3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

h3 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  font-size: 1.5em;
  line-height: 1.43;
}

ol, ul {
  padding: 0;
  padding-left: 2em;
  margin-top: 0;
  margin-bottom: 16px;
}

blockquote {
  margin: 1.2em 3em;
  padding-left: 1em;
  font-style: italic;
}

hr {
  border: 0;
  border-top: 1px dashed #d2d2d2;
  height: 0;
  margin: 1.6em 0;
}

/* page header */

.header {
  padding: 2em;
  background: #FFA91A;
}

.header h1 {
  font-size: 2.6em;
  text-align: center;
  font-weight: 700;
  margin: 0;
}

.header a, .header a:hover {
  text-decoration: none;
  color: #ffffff;
}

/* page footer */

footer {
  margin: 3em 0;
}

footer .nav {
  text-align: center;
  margin-top: 5em;
  margin-bottom: 3.5em;
}

footer .nav a {
  padding: 0 0.5em;
  font-size: 1.2em;
  text-decoration: none;
}

footer .about {
  padding: 2.2em 3em;
  text-align: center;
  color: #888;
}

/* article */

.article {
  margin: 3em 0 4em;
}

.article header .date {
  text-align: center;
  margin-top: -0.7em;
}

.article .content img {
  display: block;
  width: 100%;
}

/* code styling */

p code,
h2 code {
  font-family: Consolas,"Liberation Mono",Menlo,Courier,monospace;
  padding: 0;
  padding-top: .2em;
  padding-bottom: .2em;
  margin: 0;
  font-size: 85%;
  background-color: #f7f7f7;
  border-radius: 3px;
}

h2 code:before,
h2 code:after,
p code:before,
p code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

pre {
  font-family: Consolas,"Liberation Mono",Menlo,Courier,monospace;
  word-wrap: normal;
  padding: 16px;
  overflow: auto;
  /*font-size: 100%;*/
  font-size: 13.6px;
  line-height: 1.45;
  background-color: #f7f7f7;
  border: 0;
  border-radius: 3px;
  margin-top: 0;
  margin-bottom: 16px;
}

pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
  /*font-size: 100%;*/
  white-space: pre;
  background: transparent;
  border-radius: 3px;
}

/* syntax hl stuff */

code.lang-markdown {
  color: #424242;
}

code.lang-markdown .header,
code.lang-markdown .strong {
  font-weight: bold;
}

code.lang-markdown .emphasis {
  font-style: italic;
}

code.lang-markdown .horizontal_rule,
code.lang-markdown .link_label,
code.lang-markdown .code,
code.lang-markdown .header,
code.lang-markdown .link_url {
  color: #555;
}

code.lang-markdown .blockquote,
code.lang-markdown .bullet {
  color: #bbb;
}

/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
.tomorrow-comment, pre .comment, pre .title {
  color: #8e908c;
}

.tomorrow-red, pre .variable, pre .attribute, pre .tag, pre .regexp, pre .ruby .constant, pre .xml .tag .title, pre .xml .pi, pre .xml .doctype, pre .html .doctype, pre .css .id, pre .css .class, pre .css .pseudo {
  color: #c82829;
}

.tomorrow-orange, pre .number, pre .preprocessor, pre .built_in, pre .literal, pre .params, pre .constant {
  color: #f5871f;
}

.tomorrow-yellow, pre .class, pre .ruby .class .title, pre .css .rules .attribute {
  color: #eab700;
}

.tomorrow-green, pre .string, pre .value, pre .inheritance, pre .header, pre .ruby .symbol, pre .xml .cdata {
  color: #718c00;
}

.tomorrow-aqua, pre .css .hexcolor {
  color: #3e999f;
}

.tomorrow-blue, pre .function, pre .python .decorator, pre .python .title, pre .ruby .function .title, pre .ruby .title .keyword, pre .perl .sub, pre .javascript .title, pre .coffeescript .title {
  color: #4271ae;
}

.tomorrow-purple, pre .keyword, pre .javascript .function {
  color: #8959a8;
}

/* media queries */

@media (max-width: 690px) {
  .content-wrap {
    width: auto;
    padding: 0 1em;
  }
  .header {
    padding: 1em;
  }
  .header h1 {
    font-size: 1.4em;
  }
  .article {
    margin: 1em 0 2.5em;
  }
  .archive {
    width: 80%;
    margin: 0 auto;
  }
  .archive * {
    float: none !important;
    line-height: 1.6 !important;
    width: auto !important;
    height: auto !important;
    text-align: left !important;
    border: 0 !important;
    margin: 0 !important;
  }
  footer .nav {
    margin: 1em 0;
  }
  footer .about {
    padding: 0;
    padding-top: 1.6em;
  }
  footer .about p {
    margin-bottom: 1em;
  }
}

    </style>
  </head>
  <body>
    <header class="header">
      <div class="content-wrap">
        <div class="logo">
          <h1><a href="/">Karl O'Keeffe</a></h1>
        </div>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <header>
            <h2><a href="/blog/articles/screenshots-of-failing-cucumber-scenarios/">Screenshots of Failing Cucumber Scenarios</a></h2>
            <p class="date"><span>14. September 2009</span></p>
          </header>
          <section class="content"><p>At 7digital we use <a href="http://cukes.info/">Cucumber</a> and <a href="http://wtr.rubyforge.org/">Watir</a> for running acceptance tests on some of our&nbsp;websites.</p>
<p>These tests can help greatly in spotting problems with configuration, databases, load balancing, etc that unit testing&nbsp;misses.</p>
<p>But because the tests exercise the whole system, from the browser all the way through the the database, they can tend be flakier than unit tests. Then can fail one minute and work the next, which can make debugging them a&nbsp;nightmare.</p>
<p>So, to make the task of spotting the cause of failing acceptance tests easier, how about we set up Cucumber to take a screenshot of the desktop (and therefore browser) any time a scenario&nbsp;fails.</p>
<h2 id="install-screenshot-software">Install Screenshot&nbsp;Software</h2>
<p>The first thing we need to do is install something that can take screenshots. The simplest solution I found is a tiny little windows app called <a href="http://90kts.com/blog/2008/capturing-screenshots-in-watir/">SnapIt</a>. It takes a single screenshot of the primary screen and saves it to a location of your choice. No more, no&nbsp;less.</p>
<ul>
<li><a href="http://90kts.com/blog/wp-content/uploads/2008/06/snapit.exe">Download SnapIt</a> and save it a known location (e.g. <code>C:\Tools\SnapIt.exe</code>)</li>
</ul>
<h2 id="tell-cucumber-to-take-a-screenshot-when-a-scenario-fails">Tell Cucumber to Take a Screenshot When a Scenario&nbsp;Fails</h2>
<p>Now we need to tell Cucumber to take a screenshot. To do so we’ll add a function to the Cucumber <code>World</code> that will take a screenshot if needed, and run this in the <code>After</code> scenario hook. To do this modify your <code>features/support/env.rb</code> file.</p>
<h4 id="env-rb">env.rb</h4>
<pre><code class="lang-ruby"><span class="class"><span class="keyword">class</span> <span class="title">DefaultWorld</span></span>

  <span class="comment"># Screenshot directory, relative to this env.rb file</span>
  DEFAULT_SCREENSHOT_PATH = File.expand_path(File.dirname(__FILE_<span class="number">_</span>) + <span class="string">'/../../../output/cucumber/screenshots/'</span>)

  <span class="comment"># Absolute location of SnapIt</span>
  SNAPIT_PATH = <span class="string">'C:\\Tools\\SnapIt.exe'</span>

  <span class="function"><span class="keyword">def</span> <span class="title">take_screenshot_if_failed</span><span class="params">(scenario)</span></span>
    <span class="keyword">if</span> (scenario.status != <span class="symbol">:passed</span>)
      scenario_name = scenario.to_sexp[<span class="number">3</span>].gsub /[^\w\-]/, <span class="string">' '</span>
      time = Time.now.strftime(<span class="string">"%Y-%m-%d %H%M"</span>)
      screenshot_path = DefaultWorld::DEFAULT_SCREENSHOT_PATH + <span class="string">'/'</span> +  time + <span class="string">' - '</span> + scenario_name + <span class="string">'.png'</span>
      cmd = DefaultWorld::SNAPIT_PATH + <span class="string">' "'</span> + screenshot_path + <span class="string">'"'</span>
      <span class="string">%x{<span class="subst">#{cmd}</span>}</span>
    <span class="keyword">end</span>    
  <span class="keyword">end</span>

  <span class="comment"># [...] Other DefaultWorld code here if needed</span>

<span class="keyword">end</span>

World <span class="keyword">do</span>
  DefaultWorld.new
<span class="keyword">end</span>

After <span class="keyword">do</span> <span class="params">|scenario|</span>
  take_screenshot_if_failed(scenario)

  <span class="comment"># [...] Other After hook code here if needed  </span>

<span class="keyword">end</span>
</code></pre>
<p>Just modify the constants in the above code to point to the locations of SnapIt and a directory to save the screenshots&nbsp;too.</p>
<h2 id="what-the-code-does">What the Code&nbsp;Does</h2>
<p>The code will only take a screenshot if the scenario fails to&nbsp;pass.</p>
<p>It then extracts the name of the scenario, and converts it to a filename friendly string (e.g. <code>Monkey&#39;s should eat &quot;things&quot;</code> =&gt; <code>Monkey s should eat things</code>). It then prepends the current date and time, and uses this string as the filename for the&nbsp;screenshot.</p>
<p>This allows you to easily find screenshots for a specific scenario or&nbsp;time.</p>
<h2 id="run-a-failing-test-and-check-out-the-screenshot">Run a Failing Test and Check Out the&nbsp;Screenshot</h2>
<p>Now you can run Cucumber as normal, watch a test fail, and you should see a screenshot appear in the directory you specified. And hopefully it will help you work out what went wrong,&nbsp;enjoy!</p>
<p>If the screenshot fails to appear, it could be because of an error in the ruby code. But Cucumber seems to hide any execptions within the After hook, so you may need to add <code>puts</code> statements to work out what is going&nbsp;wrong.</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/blog/">Full blog</a></div>
        <section class="about"><p>Personal homepage of <a href="/">Karl O’Keeffe</a>.</p>

        </section>
      </div>
    </footer>
  </body>
</html>
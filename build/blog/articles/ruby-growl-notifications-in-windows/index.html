<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Ruby Growl Notifications in Windows - Karl O'Keeffe
    </title>
    <link rel="alternate" href="//feed.xml" type="application/rss+xml" title="">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <div class="logo">
          <h1><a href="/">Karl O'Keeffe</a></h1>
          <p class="description"></p>
        </div>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>I previously posted an update that enables <a href="/articles/autotest-growl-for-windows/">Growl notifications for Autotest in Windows</a>.</p>
<p>Which is nice, but what about other Ruby programs, they might want to send Growl notifications too. To this end Vision Media have produced a <a href="http://github.com/visionmedia/growl/tree/master">Ruby Growl gem</a> which makes it easy for any Ruby program to send Growl&nbsp;notifications.</p>
<p>But the visionmedia-growl gem only works on&nbsp;<span class="caps">OSX</span>.</p>
<h2 id="now-with-added-windows-support">Now With Added Windows&nbsp;Support</h2>
<p>So I had a go at adding Windows support. The short version is that it works, but the code is seriously ugly and not well tested (you have been&nbsp;warned!).</p>
<p>Check out <a href="http://github.com/karl/growl/tree/master">my visionmedia-growl fork</a>. Or just install the&nbsp;gem:</p>
<pre><code class="lang-bash">sudo gem install karl-growl --source http://gems.github.com
</code></pre>
<h2 id="packaging-growlnotify-">Packaging <code>growlnotify</code></h2>
<p>First up I decided to package both the <span class="caps">OSX</span> and Windows versions of <code>growlnotify</code> with the&nbsp;gem.</p>
<p>This is a departure from the existing gem, which requires that you have installed <code>growlnotify</code> yourself. I wanted to be able to include this gem in new projects without having to bother users to download extra&nbsp;dependencies.</p>
<h2 id="choose-the-right-growlnotify-">Choose the Right <code>growlnotify</code></h2>
<p>I decide which growlnotify to use by checking which platform we are running&nbsp;on:</p>
<pre><code class="lang-ruby">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">is_windows?</span></span>
    processor, platform, *rest = <span class="constant">RUBY_PLATFORM</span>.split(<span class="string">"-"</span>)
    platform == <span class="string">'mswin32'</span>
  <span class="keyword">end</span>

  <span class="comment">##</span>
  <span class="comment"># Execute +args+ against the binary.</span>

  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">exec</span> <span class="title">*</span><span class="title">args</span></span>
    bin = <span class="constant">PACKAGED_BIN</span>
    bin += <span class="string">'.com'</span> <span class="keyword">if</span> is_windows?

    <span class="constant">Kernel</span>.system bin, *args
  <span class="keyword">end</span>
</code></pre>
<h2 id="different-switches-on-different-operating-systems">Different Switches on Different Operating&nbsp;Systems</h2>
<p>The biggest headache with adding Windows support was adding the ability to generate Windows style command line&nbsp;arguments.</p>
<p>Example <span class="caps">OSX</span> command&nbsp;line:</p>
<pre><code class="lang-bash">growlnotify --message llamas --title Llama! --image images/llama.png
</code></pre>
<p>Example Windows command&nbsp;line:</p>
<pre><code class="lang-bash">growlnotify.com llamas /t:Llama! /i:images/llama.png
</code></pre>
<p>Note that in the Windows command line, switches are specified with <code>/_x_:</code> prefix, and no space. The names of the switches don’t correspont exactly with the <span class="caps">OSX</span>&nbsp;ones.</p>
<p>Also, with the Windows version of <code>growlnotify</code> you don’t give an switch for the message body, just include it as the first&nbsp;argument.</p>
<h2 id="adding-support-for-windows-style-switches">Adding Support for Windows Style&nbsp;Switches</h2>
<p>The first part of adding this support was to map the <span class="caps">OSX</span> switches to their Windows counterparts (where they&nbsp;existed).</p>
<pre><code class="lang-ruby">    switch <span class="symbol">:title</span>,      <span class="symbol">:t</span>
    switch <span class="symbol">:sticky</span>,     <span class="symbol">:s</span>
    switch <span class="symbol">:priority</span>,   <span class="symbol">:p</span>
    switch <span class="symbol">:host</span>,       <span class="symbol">:host</span>
    switch <span class="symbol">:password</span>,   <span class="symbol">:pass</span>
    switch <span class="symbol">:port</span>,       <span class="symbol">:port</span>

    switch <span class="symbol">:name</span>,       <span class="symbol">:a</span>
    switch <span class="symbol">:message</span>,    <span class="symbol">:<span class="caps">EMPTY</span></span>
    switch <span class="symbol">:image</span>,      <span class="symbol">:i</span>
    switch <span class="symbol">:identifier</span>, <span class="symbol">:id</span>

    switch <span class="symbol">:iconpath</span>,   <span class="keyword">nil</span>
    switch <span class="symbol">:appIcon</span>,    <span class="keyword">nil</span>
    switch <span class="symbol">:icon</span>,       <span class="keyword">nil</span>

    switch <span class="symbol">:udp</span>,        <span class="keyword">nil</span>
    switch <span class="symbol">:auth</span>,       <span class="symbol">:hash</span>
    switch <span class="symbol">:crypt</span>,      <span class="keyword">nil</span>
</code></pre>
<p>As you can see, not all <span class="caps">OSX</span> switches are available in the Windows version of <code>growlnotify</code>. I dealt with this at the moment, by just stripping out any switches that won’t work in&nbsp;Windows.</p>
<p>Finally I altered (hacked?) the Growl <code>run</code> method, to produce parameter strings for either <span class="caps">OSX</span> or&nbsp;Windows.</p>
<pre><code class="lang-ruby">    <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>
      raise <span class="constant">Error</span>, <span class="string">'message required'</span> <span class="keyword">unless</span> message
      <span class="keyword">self</span>.<span class="keyword">class</span>.switches.each <span class="keyword">do</span> |name, win_name|
        <span class="keyword">if</span> send(<span class="symbol">:<span class="string">"<span class="subst">#{name}</span>?"</span></span>)
          value = send(name).to_s <span class="keyword">if</span> send(name) &amp;&amp; !(<span class="constant">TrueClass</span> === send(name))
          <span class="keyword">if</span> is_windows?
            <span class="keyword">next</span> <span class="keyword">if</span> win_name.<span class="keyword">nil</span>?

            switch = (win_name == <span class="symbol">:<span class="caps">EMPTY</span></span>) ? <span class="string">""</span> <span class="symbol">:</span> <span class="string">"/<span class="subst">#{win_name}</span>:"</span>
            args &lt;&lt; switch + value
          <span class="keyword">else</span>
            args &lt;&lt; <span class="string">"--<span class="subst">#{name}</span>"</span>
            args &lt;&lt; value
          <span class="keyword">end</span>
        <span class="keyword">end</span>
      <span class="keyword">end</span>
      <span class="constant">Growl</span>.exec *args
    <span class="keyword">end</span>
</code></pre>
<p>The main points of interest here are the The windows switches don’t have any space between the switch name and the value. So instead they are concatenated together into a single&nbsp;string.</p>
<p>Finally we deal with the special case where using the Windows version of <code>growlnotify</code> we need to add the message parameter without a switch, so we use the special token <code>:EMPTY</code> to deal with&nbsp;this.</p>
<h2 id="the-result">The&nbsp;Result</h2>
<p>The results of this is a <a href="http://github.com/karl/growl/tree/master">Ruby gem that supports Growl notifications in Windows</a>. The gem can be installed with the following&nbsp;commands:</p>
<pre><code class="lang-bash">sudo gem install karl-growl --source http://gems.github.com
</code></pre>
<p>And used in your Ruby program as&nbsp;follows:</p>
<pre><code class="lang-ruby"><span class="constant">Growl</span>.notify {
    <span class="keyword">self</span>.message = <span class="string">'Hello World'</span>
    <span class="keyword">self</span>.image = <span class="constant">File</span>.join <span class="string">'path'</span>, <span class="string">'to'</span>, <span class="string">'image.png'</span>
  }
</code></pre>
<p>For more usage examples see the <a href="http://github.com/karl/growl/tree/master">karl-growl site</a>.</p>
<h2 id="known-issues">Known&nbsp;Issues</h2>
<p>There are a few known issues. The biggest of which no support for normalised&nbsp;icons.</p>
<p>To support <span class="caps">OSX</span> and Windows always give a path to an image,&nbsp;e.g.</p>
<pre><code class="lang-ruby">  <span class="symbol">:image</span> =&gt; <span class="string">'path/to/image.png'</span>
</code></pre>
<p>There are a number of switches that only work in <span class="caps">OSX</span>, and are ignored in Windows. Unsupported switches&nbsp;are:</p>
<pre><code class="lang-ruby">  <span class="symbol">:iconpath</span>
  <span class="symbol">:appIcon</span>
  <span class="symbol">:icon</span>
  <span class="symbol">:udp</span>
  <span class="symbol">:crypt</span>
</code></pre>
<p>The gem has only received the most cursory of testing, so there may be a whole host of other issues, be&nbsp;warned!</p>
<h2 id="the-future">The&nbsp;Future</h2>
<p>I’m treating the current version of this gem, as a design spike, a proof of concept that shows we can have cross Operating System support. The code is a real mess, and has no unit tests, but I’m releasing it here to follow the <a href="http://anarchycreek.com/2009/07/11/better-now-beats-best-later/">‘better now beats best later’</a>&nbsp;rule.</p>
<p>I hope to refactor the code into something more production worthy when I get a&nbsp;chance.</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/blog/">« Full blog</a></div>
        <section class="about"><p>Personal homepage of Karl O’Keeffe.</p>

        </section>
      </div>
    </footer>
  </body>
</html>